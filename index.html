<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Image Generator</title>
  <style>
    :root{--bg:#0b0f14;--card:#121826;--text:#e6eef7;--muted:#a9b3c5;--accent:#6cc5ff;--ok:#34d399;--max:1100px}
    *{box-sizing:border-box}
    body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,#0b0f14,#0a0d12)}
    header{position:sticky;top:0;background:rgba(18,24,38,.9);backdrop-filter:blur(8px);border-bottom:1px solid #1c2436}
    .wrap{max-width:var(--max);margin:0 auto;padding:16px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:clamp(18px,4vw,26px);margin:0}
    main{max-width:var(--max);margin:20px auto;padding:0 16px;display:grid;gap:16px}
    .panel{background:var(--card);border:1px solid #1c2436;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .inner{padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    label{display:block;margin-bottom:6px;color:var(--muted)}
    input[type=text],textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #222e46;background:#0e1422;color:var(--text);outline:none}
    textarea{resize:vertical;min-height:96px}
    .row{display:grid;gap:10px}
    .two{grid-template-columns:1fr 1fr}
    button{appearance:none;border:none;background:linear-gradient(135deg,#7bd0ff,#5cb3ff);color:#07131f;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(88,173,255,.35)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .status{font-size:14px;margin-left:8px}
    .drop{border:2px dashed #2a3959;border-radius:16px;padding:18px;text-align:center;background:#0d1422;color:var(--muted)}
    .drop.drag{border-color:var(--accent);background:#0e1828;color:var(--text)}
    figure{margin:0;border:1px solid #1c2436;border-radius:12px;overflow:hidden;background:#0e1420;display:flex;flex-direction:column}
    figcaption{padding:8px 10px;color:var(--muted);border-top:1px solid #1c2436;display:flex;align-items:center;justify-content:space-between;gap:8px}
    img{display:block;width:100%;height:auto}
    a.dl{font-size:12px;color:#9fd0ff;text-decoration:none}
    a.dl:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>3D Image Generator</h1>
      <span style="opacity:.7;font-size:12px">Client demo · v2</span>
    </div>
  </header>

  <main>
    <!-- INPUT PANEL -->
    <section class="panel">
      <div class="inner">
        <h2 style="margin:0 0 8px">Upload & Describe</h2>
        <p class="muted">Choose an image and add a short description. We’ll call your n8n webhook and show <strong>all outputs</strong> (edited + six views) below with download buttons.</p>

        <form id="gen-form" class="row" autocomplete="off">
          <div class="drop" id="drop">
            <input id="file" name="image" type="file" accept="image/*" style="display:none" required />
            <p><strong>Drag & drop</strong> an image here, or <a href="#" id="pick">browse</a></p>
            <p class="muted" id="fileInfo" style="font-size:12px">No file selected</p>
          </div>

          <label for="desc">Description</label>
          <textarea id="desc" name="description" placeholder="Describe the subject (color, material, details)…" required></textarea>

          <div class="two row">
            <div>
              <label for="endpoint">Webhook Endpoint</label>
              <input id="endpoint" type="text" placeholder="https://YOUR-N8N/webhook/api/generate-3d" />
              <p class="muted" style="font-size:12px">Saved locally in your browser.</p>
            </div>
            <div>
              <label for="key">API Key (optional)</label>
              <input id="key" type="text" placeholder="x-api-key value if enabled" />
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:12px">
            <button id="submit">Generate</button>
            <span id="status" class="status muted">Idle</span>
          </div>
        </form>
      </div>
    </section>

    <!-- RESULTS PANEL -->
    <section class="panel">
      <div class="inner">
        <h2 style="margin:0 0 8px">Results</h2>
        <div id="results" class="grid" aria-live="polite"></div>
        <p id="hint" class="muted" style="margin-top:8px;font-size:12px">Tip: If some views are empty, make sure those nodes set <code>options.binaryPropertyOutput</code> in n8n and are included in the response JSON.</p>
      </div>
    </section>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const state = { file:null, endpoint: localStorage.getItem('n8n_endpoint')||'', key: localStorage.getItem('n8n_key')||'' };
    const drop = $('#drop'), fileInput = $('#file'), pick = $('#pick'), fileInfo = $('#fileInfo');
    const endpointEl = $('#endpoint'), keyEl = $('#key'), form = $('#gen-form');
    const statusEl = $('#status'), results = $('#results'), submitBtn = $('#submit');

    endpointEl.value = state.endpoint; keyEl.value = state.key;
    function setStatus(text, ok=false){ statusEl.textContent = text; statusEl.style.color = ok? 'var(--ok)': 'var(--muted)'; }

    // Drag & Drop
    ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.add('drag')}));
    ['dragleave','drop'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.remove('drag')}));
    drop.addEventListener('drop', (e)=>{ const f = e.dataTransfer.files?.[0]; if(f){ fileInput.files = e.dataTransfer.files; state.file=f; fileInfo.textContent = f.name; } });
    pick.addEventListener('click', (e)=>{ e.preventDefault(); fileInput.click(); });
    fileInput.addEventListener('change', ()=>{ const f = fileInput.files?.[0]; if(f){ state.file=f; fileInfo.textContent = f.name; } });

    function renderImage(label, value){
      if(!value) return;
      let src = value;
      if(!(value||'').startsWith('http') && !(value||'').startsWith('data:')) src = 'data:image/png;base64,' + value;
      const fig = document.createElement('figure');
      const img = document.createElement('img'); img.alt = label; img.src = src; fig.appendChild(img);
      const cap = document.createElement('figcaption');
      const name = document.createElement('span'); name.textContent = label;
      const a = document.createElement('a'); a.className='dl'; a.href = src; a.download = (label.toLowerCase().replace(/\s+/g,'-')) + '.png'; a.textContent = 'Download';
      cap.appendChild(name); cap.appendChild(a); fig.appendChild(cap);
      results.appendChild(fig);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const endpoint = endpointEl.value.trim(); const key = keyEl.value.trim();
      if(!endpoint) return alert('Please set your n8n Webhook endpoint');
      if(!state.file) return alert('Please choose an image');
      const desc = $('#desc').value.trim(); if(!desc) return alert('Please enter a description');

      localStorage.setItem('n8n_endpoint', endpoint); localStorage.setItem('n8n_key', key);
      const fd = new FormData(); fd.append('image', state.file); fd.append('description', desc);

      submitBtn.disabled = true; results.innerHTML = ''; setStatus('Uploading & processing…');
      try{
        const res = await fetch(endpoint, { method:'POST', headers: key? {'x-api-key': key} : undefined, body: fd });
        const text = await res.text(); if(!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
        let data; try{ data = JSON.parse(text); } catch{ throw new Error('Invalid JSON from API'); }

        const order = [
          ['Edited', data.edited_url || data.edited],
          ['Front',  data.front_url  || data.front],
          ['Back',   data.back_url   || data.back],
          ['Left',   data.left_url   || data.left],
          ['Right',  data.right_url  || data.right],
          ['Top',    data.top_url    || data.top],
          ['Bottom', data.bottom_url || data.bottom]
        ];
        let count = 0;
        for(const [label,val] of order){ if(val){ renderImage(label,val); count++; } }
        if(count===0) setStatus('No images returned. Check your Respond to Webhook payload.'); else setStatus(`Done! Rendered ${count} image(s).`, true);
      }catch(err){ console.error(err); setStatus(err.message||'Error'); alert('Error: '+(err.message||err)); }
      finally{ submitBtn.disabled = false; }
    });
  </script>
</body>
</html>
